{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-8">
      <h2 class="mb-4">Green Metadata YML Generator</h2>

      <!-- Basic Information Section -->
      <div id="basic-section" class="form-section">
        <h3 class="mb-3">Basic Information</h3>
        <form id="basic-form" class="needs-validation" novalidate>
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6 mb-3">
              {{ basic_form.title.label_tag }}
              {{ basic_form.title }}
            </div>
            <div class="col-md-6 mb-3">
              {{ basic_form.repository_url.label_tag }}
              {{ basic_form.repository_url }}
            </div>
          </div>

          <div class="mb-3">
            {{ basic_form.description.label_tag }}
            {{ basic_form.description }}
          </div>

          <div class="mb-3">
            {{ basic_form.keywords.label_tag }}
            {{ basic_form.keywords }}
            <small class="text-muted">Separate keywords with commas</small>
          </div>

          <button type="button" class="btn btn-primary" onclick="showSection('embodied')">Next: Embodied Impact</button>
        </form>
      </div>

      <!-- Embodied Impact Section -->
      <div id="embodied-section" class="form-section" style="display: none;">
        <h3 class="mb-3">Embodied Impact</h3>
        <form id="embodied-form" class="needs-validation" novalidate>
          {% csrf_token %}

          <!-- Carbon Footprint -->
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">Carbon Footprint</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  {{ embodied_form.carbon_footprint.label_tag }}
                  {{ embodied_form.carbon_footprint }}
                </div>
                <div class="col-md-6">
                  {{ embodied_form.carbon_footprint_source.label_tag }}
                  {{ embodied_form.carbon_footprint_source }}
                </div>
              </div>
            </div>
          </div>

          <!-- Depletion of Abiotic Resources -->
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">Depletion of Abiotic Resources (Minerals, Metals)</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  {{ embodied_form.depletion_abiotic.label_tag }}
                  {{ embodied_form.depletion_abiotic }}
                </div>
                <div class="col-md-6">
                  {{ embodied_form.depletion_abiotic_source.label_tag }}
                  {{ embodied_form.depletion_abiotic_source }}
                </div>
              </div>
            </div>
          </div>

          <!-- Particulate Matter Emissions -->
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">Particulate Matter Emissions</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  {{ embodied_form.particulate_matter.label_tag }}
                  {{ embodied_form.particulate_matter }}
                </div>
                <div class="col-md-6">
                  {{ embodied_form.particulate_matter_source.label_tag }}
                  {{ embodied_form.particulate_matter_source }}
                </div>
              </div>
            </div>
          </div>

          <!-- Acidification Potential -->
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">Acidification Potential</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  {{ embodied_form.acidification_potential.label_tag }}
                  {{ embodied_form.acidification_potential }}
                </div>
                <div class="col-md-6">
                  {{ embodied_form.acidification_potential_source.label_tag }}
                  {{ embodied_form.acidification_potential_source }}
                </div>
              </div>
            </div>
          </div>

          <!-- Ionising Radiation -->
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">Ionising Radiation Related to Human Health</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  {{ embodied_form.ionising_radiation.label_tag }}
                  {{ embodied_form.ionising_radiation }}
                </div>
                <div class="col-md-6">
                  {{ embodied_form.ionising_radiation_source.label_tag }}
                  {{ embodied_form.ionising_radiation_source }}
                </div>
              </div>
            </div>
          </div>

          <!-- Photochemical Ozone Formation -->
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">Photochemical Ozone Formation</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  {{ embodied_form.photochemical_ozone.label_tag }}
                  {{ embodied_form.photochemical_ozone }}
                </div>
                <div class="col-md-6">
                  {{ embodied_form.photochemical_ozone_source.label_tag }}
                  {{ embodied_form.photochemical_ozone_source }}
                </div>
              </div>
            </div>
          </div>

          <!-- Abiotic Depletion Potential (Fossil Fuels) -->
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">Abiotic Depletion Potential (Fossil Fuels)</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  {{ embodied_form.abiotic_depletion_fossil.label_tag }}
                  {{ embodied_form.abiotic_depletion_fossil }}
                </div>
                <div class="col-md-6">
                  {{ embodied_form.abiotic_depletion_fossil_source.label_tag }}
                  {{ embodied_form.abiotic_depletion_fossil_source }}
                </div>
              </div>
            </div>
          </div>

          <!-- Freshwater Eco-Toxicity Potential -->
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">Freshwater Eco-Toxicity Potential</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  {{ embodied_form.freshwater_ecotoxicity.label_tag }}
                  {{ embodied_form.freshwater_ecotoxicity }}
                </div>
                <div class="col-md-6">
                  {{ embodied_form.freshwater_ecotoxicity_source.label_tag }}
                  {{ embodied_form.freshwater_ecotoxicity_source }}
                </div>
              </div>
            </div>
          </div>

          <button type="button" class="btn btn-primary" onclick="showSection('operational')">Next: Operational
            Impact</button>
        </form>
      </div>

      <!-- Operational Impact Section -->
      <div id="operational-section" class="form-section" style="display: none;">
        <h3 class="mb-3">Operational Impact</h3>
        <form id="operational-form" class="needs-validation" novalidate>
          {% csrf_token %}

          <!-- Impact Values -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Impact Values</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4">
                  {{ operational_form.energy_consumption.label_tag }}
                  {{ operational_form.energy_consumption }}
                </div>
                <div class="col-md-4">
                  {{ operational_form.carbon_footprint.label_tag }}
                  {{ operational_form.carbon_footprint }}
                </div>
                <div class="col-md-4">
                  {{ operational_form.water_consumption.label_tag }}
                  {{ operational_form.water_consumption }}
                </div>
              </div>
            </div>
          </div>

          <!-- Methods and Scope -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Methods and Scope</h5>
            </div>
            <div class="card-body">
              <!-- Software and Hardware Boundaries -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <h6>{{ operational_form.software_boundaries.label }}</h6>
                  {{ operational_form.software_boundaries }}
                </div>
                <div class="col-md-6">
                  <h6>{{ operational_form.hardware_boundaries.label }}</h6>
                  {{ operational_form.hardware_boundaries }}
                </div>
              </div>

              <!-- Tool Stages -->
              <div class="mb-4">
                <h6>{{ operational_form.tool_stages.label }}</h6>
                {{ operational_form.tool_stages }}
              </div>

              <!-- Hardware Details -->
              <div class="mb-4">
                {{ operational_form.details_of_hardware.label_tag }}
                {{ operational_form.details_of_hardware }}
              </div>

              <!-- Infrastructure -->
              <div class="card mb-4">
                <div class="card-header">
                  <h6 class="mb-0">Infrastructure</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <h6>{{ operational_form.infrastructure_elements.label }}</h6>
                    {{ operational_form.infrastructure_elements }}
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-6">
                      {{ operational_form.pue_value.label_tag }}
                      {{ operational_form.pue_value }}
                    </div>
                    <div class="col-md-6">
                      {{ operational_form.pue_method.label_tag }}
                      {{ operational_form.pue_method }}
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      {{ operational_form.wue_value.label_tag }}
                      {{ operational_form.wue_value }}
                    </div>
                    <div class="col-md-6">
                      {{ operational_form.wue_method.label_tag }}
                      {{ operational_form.wue_method }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Electricity Carbon Intensity -->
              <div class="row">
                <div class="col-md-6">
                  {{ operational_form.electrical_carbon_intensity.label_tag }}
                  {{ operational_form.electrical_carbon_intensity }}
                </div>
                <div class="col-md-6">
                  {{ operational_form.electrical_carbon_intensity_source.label_tag }}
                  {{ operational_form.electrical_carbon_intensity_source }}
                </div>
              </div>
            </div>
          </div>

          <button type="button" class="btn btn-primary" onclick="showSection('preview')">Next: Preview</button>
        </form>
      </div>

      <!-- Preview Section -->
      <div id="preview-section" class="form-section" style="display: none;">
        <h3 class="mb-3">Preview & Download</h3>
        <button type="button" class="btn btn-success mb-3" onclick="downloadYml()">
          <i class="fas fa-download"></i> Download YML
        </button>
      </div>
    </div>

    <!-- Live Preview Sidebar -->
    <div class="col-md-4 position-fixed end-0" style="top: 0; height: 100vh; background: #1a1a1a; padding: 2rem;">
      <h4 class="text-white mb-3">Live Preview</h4>
      <pre id="yml-preview" class="text-light"
        style="font-family: 'Monaco', 'Consolas', monospace; font-size: 0.9rem; white-space: pre-wrap;">Loading preview...</pre>
    </div>
  </div>
</div>

{% block extra_js %}
<style>
  .list-unstyled {
    padding-left: 0;
    list-style: none;
  }

  .list-unstyled li {
    margin-bottom: 0.5rem;
  }

  .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0, 0, 0, .125);
  }

  .card-header h5,
  .card-header h6 {
    margin-bottom: 0;
    color: #2c3e50;
  }
</style>

<script>
  let formData = {};
  let debounceTimer;

  // Function to update preview with debounce
  function updatePreview() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      const queryString = new URLSearchParams(formData).toString();
      fetch(`/metadata/yml-preview/?${queryString}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('yml-preview').textContent = data.yml;
          }
        });
    }, 300);
  }

  // Function to collect form data
  function collectFormData(form) {
    const formInputs = form.querySelectorAll('input, textarea, select');
    formInputs.forEach(input => {
      if (input.type === 'checkbox') {
        if (input.checked) {
          const name = input.name;
          if (!formData[name]) {
            formData[name] = [];
          }
          formData[name].push(input.value);
        }
      } else {
        const name = input.name;
        const value = input.value;
        if (name) {
          formData[name] = value;
        }
      }
    });
    updatePreview();
  }

  // Add input event listeners to all forms
  ['basic-form', 'embodied-form', 'operational-form'].forEach(formId => {
    const form = document.getElementById(formId);
    const inputs = form.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
      if (input.type === 'checkbox') {
        input.addEventListener('change', () => {
          // Clear existing values for this checkbox group
          const name = input.name;
          formData[name] = [];
          // Collect all checked values
          form.querySelectorAll(`input[name="${name}"]:checked`).forEach(checkbox => {
            if (!formData[name]) {
              formData[name] = [];
            }
            formData[name].push(checkbox.value);
          });
          updatePreview();
        });
      } else {
        input.addEventListener('input', () => {
          collectFormData(form);
        });
      }
    });
  });

  function showSection(sectionName) {
    // Hide all sections
    document.querySelectorAll('.form-section').forEach(section => {
      section.style.display = 'none';
    });

    // Show requested section
    document.getElementById(sectionName + '-section').style.display = 'block';

    // Update progress sidebar
    document.querySelectorAll('.progress-item').forEach(item => {
      item.classList.remove('active');
      if (item.dataset.section === sectionName) {
        item.classList.add('active');
      }
    });
  }

  function downloadYml() {
    const queryString = new URLSearchParams(formData).toString();
    window.location.href = `/metadata/download/?${queryString}`;
  }

  // Initialize progress tracking
  document.querySelectorAll('.progress-item').forEach(item => {
    item.addEventListener('click', () => {
      showSection(item.dataset.section);
    });
  });

  // Initial preview update
  updatePreview();
</script>
{% endblock %}
{% endblock %}